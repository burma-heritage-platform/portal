<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Burma Heritage Portal</title>
    <!-- Use Inter and Noto Serif fonts from Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&family=Noto+Serif:wght@700&display=swap" rel="stylesheet">
    <!-- Load Tailwind CSS from a CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8; /* Softer background color */
            color: #333;
        }
        h1, h2, h3 {
            font-family: 'Noto Serif', serif;
        }
        .card-animation {
            animation: fadeIn 0.5s ease-out forwards;
        }
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .active-filter {
            background-color: #0d9488;
            color: white;
            box-shadow: 0 4px 14px -1px rgba(0, 0, 0, 0.2), 0 2px 6px -1px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }
        .single-page-enter-active, .form-enter-active, .info-page-enter-active {
            animation: fadeIn 0.5s ease-out forwards;
        }
        .modal {
            transition: all 0.3s ease-in-out;
        }
        .hidden {
            display: none;
        }
        .timeline-container {
            position: relative;
            padding-left: 50px;
        }
        .timeline-container:before {
            content: '';
            position: absolute;
            left: 20px;
            top: 0;
            width: 2px;
            height: 100%;
            background-color: #cbd5e1;
            /* Dashed line effect */
            background-image: linear-gradient(180deg, #cbd5e1 50%, transparent 50%);
            background-size: 1px 15px;
            background-repeat: repeat-y;
        }
        .timeline-item {
            position: relative;
            padding-bottom: 30px;
            animation: fadeIn 0.5s ease-out forwards;
        }
        .timeline-item:before {
            content: '';
            position: absolute;
            left: 14px;
            top: 10px;
            width: 14px;
            height: 14px;
            background-color: #38a169; /* Green dot */
            border-radius: 50%;
            z-index: 10;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col">

    <!-- Header Section -->
    <header class="bg-slate-800 text-white shadow-xl py-6 px-4 md:px-8 lg:px-12 rounded-b-3xl">
        <div class="container mx-auto flex flex-col md:flex-row justify-between items-center">
            <a href="#" id="portal-home-link" class="text-3xl font-extrabold tracking-tight mb-4 md:mb-0">
                <span class="text-teal-400">Burma</span> Heritage Portal
            </a>
            <nav class="space-x-4">
                <a href="#engineering" class="header-filter-link text-gray-300 hover:text-amber-300 transition-colors" data-category="engineering">Engineering Marvels</a>
                <a href="#archaeology" class="header-filter-link text-gray-300 hover:text-amber-300 transition-colors" data-category="archaeology">Archaeological Sites</a>
                <a href="#culture" class="header-filter-link text-gray-300 hover:text-amber-300 transition-colors" data-category="culture">Cultural Artifacts</a>
            </nav>
        </div>
    </header>

    <!-- Main Content Area -->
    <main class="container mx-auto mt-12 p-4 md:p-8 flex-grow">

        <!-- --- MAIN GRID VIEW --- -->
        <div id="main-view" class="">
            <!-- Hero Section -->
            <section class="bg-gradient-to-br from-white to-sky-50 p-8 md:p-12 rounded-3xl shadow-lg mb-12 text-center">
                <h1 class="text-4xl md:text-5xl font-extrabold text-slate-800 mb-4">Discover the Rich History of Burma</h1>
                <p class="text-lg md:text-xl text-gray-600 max-w-3xl mx-auto">A resource for engineering students, researchers, and curious citizens to explore the architectural, archaeological, and cultural heritage of Myanmar (Burma).</p>
            </section>
    
            <!-- Action buttons -->
            <div class="flex flex-col md:flex-row justify-end mb-8 gap-4">
                <button id="view-timeline-button" class="bg-indigo-500 text-white font-semibold py-3 px-6 rounded-full hover:bg-indigo-600 transition-colors shadow-md">
                    View Timeline
                </button>
                <button id="add-site-button" class="bg-emerald-500 text-white font-semibold py-3 px-6 rounded-full hover:bg-emerald-600 transition-colors shadow-md">
                    + Add New Site
                </button>
            </div>

            <!-- Search and Filter Section -->
            <section class="mb-8 flex flex-col md:flex-row items-center justify-between gap-4">
                <!-- Search bar -->
                <div class="flex items-center w-full md:w-1/2 p-2 rounded-xl bg-white shadow-lg">
                    <input id="search-input" type="text" placeholder="Search for a site or artifact..." class="w-full p-3 text-lg border-2 border-gray-300 rounded-l-xl focus:outline-none focus:border-teal-400">
                    <button id="search-clear-btn" class="text-gray-500 hover:text-gray-700 focus:outline-none p-2 hidden">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                
                <!-- Filter buttons -->
                <div class="flex flex-wrap justify-center md:justify-end gap-2 md:gap-4 w-full md:w-1/2">
                    <button data-category="all" class="filter-btn bg-teal-500 text-white font-semibold py-2 px-6 rounded-full hover:bg-teal-600 transition-colors shadow-md active-filter">All</button>
                    <button data-category="engineering" class="filter-btn bg-white text-gray-700 font-semibold py-2 px-6 rounded-full hover:bg-gray-200 transition-colors shadow-md">Engineering</button>
                    <button data-category="archaeology" class="filter-btn bg-white text-gray-700 font-semibold py-2 px-6 rounded-full hover:bg-gray-200 transition-colors shadow-md">Archaeology</button>
                    <button data-category="culture" class="filter-btn bg-white text-gray-700 font-semibold py-2 px-6 rounded-full hover:bg-gray-200 transition-colors shadow-md">Culture</button>
                </div>
            </section>
    
            <!-- Dynamic Content Grid -->
            <section id="content-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                <!-- Cards will be dynamically inserted here by JavaScript -->
            </section>
    
            <!-- Loading and No Results Message -->
            <div id="loading-message" class="text-center text-xl text-gray-500 mt-8 hidden">
                <p class="animate-pulse">Loading heritage sites...</p>
            </div>
            <div id="no-results-message" class="hidden text-center text-xl text-gray-500 mt-8">
                <p>No heritage sites found for your search.</p>
            </div>
        </div>

        <!-- --- TIMELINE VIEW (Initially Hidden) --- -->
        <div id="timeline-view" class="hidden single-page-enter-active">
            <button id="back-button-timeline" class="flex items-center text-gray-600 hover:text-teal-600 transition-colors mb-8 text-lg font-semibold">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                </svg>
                Back to all sites
            </button>
            <div class="bg-white p-6 md:p-10 rounded-3xl shadow-lg">
                <h2 class="text-4xl md:text-5xl font-extrabold text-slate-800 mb-8">Timeline of Heritage</h2>
                <div id="timeline-content" class="timeline-container">
                    <!-- Timeline items will be dynamically inserted here -->
                </div>
            </div>
        </div>

        <!-- --- ADD/EDIT SITE FORM (Initially Hidden) --- -->
        <div id="add-site-view" class="hidden form-enter-active bg-white p-6 md:p-10 rounded-3xl shadow-lg">
            <h2 id="form-title" class="text-3xl font-extrabold text-slate-800 mb-6 text-center">Add a New Heritage Site</h2>
            <form id="add-site-form">
                <div class="mb-4">
                    <label for="site-title" class="block text-gray-700 font-semibold mb-2">Title</label>
                    <input type="text" id="site-title" name="title" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-400" required>
                </div>
                <div class="mb-4">
                    <label for="site-year" class="block text-gray-700 font-semibold mb-2">Year</label>
                    <input type="number" id="site-year" name="year" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-400" required placeholder="e.g., 1044">
                </div>
                <div class="mb-4">
                    <label for="site-description" class="block text-gray-700 font-semibold mb-2">Short Description</label>
                    <textarea id="site-description" name="description" rows="3" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-400" required></textarea>
                </div>
                <div class="mb-4">
                    <label for="site-detailed-description" class="block text-gray-700 font-semibold mb-2">Detailed Description</label>
                    <textarea id="site-detailed-description" name="detailedDescription" rows="6" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-400" required></textarea>
                </div>
                <div class="mb-4">
                    <label for="site-image" class="block text-gray-700 font-semibold mb-2">Image URL</label>
                    <input type="url" id="site-image" name="image" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-400" placeholder="e.g., https://placehold.co/600x400" required>
                </div>
                <div class="mb-6">
                    <label class="block text-gray-700 font-semibold mb-2">Categories</label>
                    <div class="flex flex-wrap gap-4">
                        <label class="inline-flex items-center">
                            <input type="checkbox" name="categories" value="engineering" class="form-checkbox text-teal-600 rounded-md focus:ring-teal-500 h-5 w-5">
                            <span class="ml-2 text-gray-700">Engineering</span>
                        </label>
                        <label class="inline-flex items-center">
                            <input type="checkbox" name="categories" value="archaeology" class="form-checkbox text-teal-600 rounded-md focus:ring-teal-500 h-5 w-5">
                            <span class="ml-2 text-gray-700">Archaeology</span>
                        </label>
                        <label class="inline-flex items-center">
                            <input type="checkbox" name="categories" value="culture" class="form-checkbox text-teal-600 rounded-md focus:ring-teal-500 h-5 w-5">
                            <span class="ml-2 text-gray-700">Culture</span>
                        </label>
                    </div>
                </div>
                <div class="flex justify-end gap-4">
                    <button type="button" id="cancel-add-site" class="bg-gray-300 text-gray-800 font-semibold py-3 px-6 rounded-full hover:bg-gray-400 transition-colors shadow-md">
                        Cancel
                    </button>
                    <button type="submit" id="submit-site-button" class="bg-teal-500 text-white font-semibold py-3 px-6 rounded-full hover:bg-teal-600 transition-colors shadow-md">
                        Add Site
                    </button>
                </div>
            </form>
        </div>

        <!-- --- SINGLE SITE VIEW (Initially Hidden) --- -->
        <div id="single-site-view" class="hidden single-page-enter-active">
            <button id="back-button" class="flex items-center text-gray-600 hover:text-teal-600 transition-colors mb-8 text-lg font-semibold">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                </svg>
                Back to all sites
            </button>
            <div class="bg-white p-6 md:p-10 rounded-3xl shadow-lg">
                <h2 id="single-site-title" class="text-4xl md:text-5xl font-extrabold text-slate-800 mb-4"></h2>
                <div class="mb-6 flex flex-wrap gap-2">
                    <span id="single-site-category" class="bg-teal-100 text-teal-800 text-sm font-medium px-4 py-1 rounded-full"></span>
                </div>
                <img id="single-site-image" src="" alt="" class="w-full h-auto rounded-3xl mb-8 shadow-xl">
                <p id="single-site-description" class="text-gray-700 leading-relaxed text-lg"></p>
                <div class="flex justify-end gap-4 mt-8">
                    <button id="edit-site-button" class="bg-amber-500 text-white font-semibold py-3 px-6 rounded-full hover:bg-amber-600 transition-colors shadow-md">
                        Edit Site
                    </button>
                    <button id="delete-site-button" class="bg-red-500 text-white font-semibold py-3 px-6 rounded-full hover:bg-red-600 transition-colors shadow-md">
                        Delete Site
                    </button>
                </div>
            </div>
        </div>

        <!-- --- COMMUNITY SECTION (Initially Hidden) --- -->
        <div id="community-view" class="hidden info-page-enter-active bg-white p-8 md:p-12 rounded-3xl shadow-lg">
            <h2 class="text-4xl md:text-5xl font-extrabold text-slate-800 mb-4">Join the Community</h2>
            <p class="text-lg md:text-xl text-gray-600 mb-6">This portal is a collaborative effort. We invite you to contribute and help us grow this resource.</p>
            
            <ul class="list-disc list-inside space-y-4 text-gray-700 text-lg mb-8">
                <li>**Contribute Sites:** Use the "Add New Site" button to share knowledge about new heritage locations, artifacts, or engineering marvels.</li>
                <li>**Update Information:** If you find inaccuracies or have more details to add, use the "Edit Site" function on any existing entry.</li>
                <li>**Spread the Word:** Share this portal with fellow students, academics, and anyone interested in the rich history of Burma.</li>
            </ul>

            <div class="mt-8">
                <h3 class="text-3xl font-extrabold text-slate-800 mb-4">Contact Us</h3>
                <p class="text-gray-700 text-lg mb-6">Have a question or a suggestion? Send us a message!</p>
                <form id="contact-form" class="space-y-4">
                    <div>
                        <label for="contact-name" class="block text-gray-700 font-semibold mb-2">Name</label>
                        <input type="text" id="contact-name" name="name" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-400" required>
                    </div>
                    <div>
                        <label for="contact-email" class="block text-gray-700 font-semibold mb-2">Email</label>
                        <input type="email" id="contact-email" name="email" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-400" required>
                    </div>
                    <div>
                        <label for="contact-message" class="block text-gray-700 font-semibold mb-2">Message</label>
                        <textarea id="contact-message" name="message" rows="5" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-400" required></textarea>
                    </div>
                    <div class="flex justify-end">
                        <button type="submit" class="bg-teal-500 text-white font-semibold py-3 px-6 rounded-full hover:bg-teal-600 transition-colors shadow-md">
                            Send Message
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- --- ABOUT SECTION (Initially Hidden) --- -->
        <div id="about-view" class="hidden info-page-enter-active bg-white p-8 md:p-12 rounded-3xl shadow-lg">
            <h2 class="text-4xl md:text-5xl font-extrabold text-slate-800 mb-4">About the Portal</h2>
            <p class="text-lg md:text-xl text-gray-600 mb-6">The Burma Heritage Portal was created as a digital repository to catalog and preserve information about the diverse heritage of Myanmar (Burma).</p>
            <p class="text-gray-700 leading-relaxed text-lg mb-4">Our mission is to provide an accessible, open-source platform for students, engineers, archaeologists, and cultural enthusiasts. By documenting these sites, we aim to highlight the ingenuity of ancient and modern Burmese craftsmanship and ensure this knowledge is preserved for future generations.</p>
            <p class="text-gray-700 leading-relaxed text-lg">The project began as an academic exercise and has grown into a community-driven initiative. We are committed to maintaining the accuracy and integrity of the data presented here.</p>
        </div>

        <!-- --- PRIVACY & TERMS SECTION (Initially Hidden) --- -->
        <div id="privacy-terms-view" class="hidden info-page-enter-active bg-white p-8 md:p-12 rounded-3xl shadow-lg">
            <h2 class="text-4xl md:text-5xl font-extrabold text-slate-800 mb-4">Privacy & Terms</h2>
            <h3 class="text-2xl font-bold text-gray-700 mb-2">Privacy Policy</h3>
            <p class="text-gray-700 leading-relaxed text-lg mb-4">All data added to this portal is considered public. We use a cloud-based database (Firestore) to store the site information, which is openly accessible to anyone using this application. We do not collect any personal information beyond what is necessary for authentication and collaboration, and all data you add to the portal is viewable by other users.</p>
            <h3 class="text-2xl font-bold text-gray-700 mb-2">Terms of Use</h3>
            <p class="text-gray-700 leading-relaxed text-lg mb-4">By using this portal, you agree to these terms. All content and contributions are made with the understanding that they will be publicly available and may be edited by other users. The accuracy of the information is a collaborative effort, and the portal is not liable for any inaccuracies. This is a volunteer-run project and is provided as-is without any warranties.</p>
        </div>

        <!-- Custom Success Modal (No native alerts) -->
        <div id="success-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden modal">
            <div class="bg-white rounded-xl p-8 shadow-lg max-w-sm w-full text-center">
                <p id="success-modal-text" class="text-lg font-semibold text-green-600 mb-4">Site Added Successfully!</p>
                <button id="success-modal-close" class="bg-green-500 text-white py-2 px-6 rounded-full hover:bg-green-600 transition-colors">
                    OK
                </button>
            </div>
        </div>
        
        <!-- Custom Contact Success Modal -->
        <div id="contact-success-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden modal">
            <div class="bg-white rounded-xl p-8 shadow-lg max-w-sm w-full text-center">
                <p class="text-lg font-semibold text-green-600 mb-4">Thank you! Your message has been sent.</p>
                <button id="contact-success-modal-close" class="bg-green-500 text-white py-2 px-6 rounded-full hover:bg-green-600 transition-colors">
                    OK
                </button>
            </div>
        </div>

        <!-- Custom Confirmation Modal for Deletion -->
        <div id="delete-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden modal">
            <div class="bg-white rounded-xl p-8 shadow-lg max-w-sm w-full text-center">
                <p class="text-lg font-semibold text-red-600 mb-4">Are you sure you want to delete this site?</p>
                <p class="text-sm text-gray-500 mb-6">This action cannot be undone.</p>
                <div class="flex justify-center gap-4">
                    <button id="cancel-delete" class="bg-gray-300 text-gray-800 py-2 px-6 rounded-full hover:bg-gray-400 transition-colors">
                        Cancel
                    </button>
                    <button id="confirm-delete" class="bg-red-500 text-white py-2 px-6 rounded-full hover:bg-red-600 transition-colors">
                        Delete
                    </button>
                </div>
            </div>
        </div>
        
    </main>

    <!-- Footer Section -->
    <footer class="bg-slate-800 text-gray-400 text-center py-6 px-4 rounded-t-3xl mt-12">
        <p>&copy; 2025 Burma Heritage Portal. All rights reserved.</p>
        <div class="mt-4 space-x-4">
            <a href="#" class="info-link text-gray-400 hover:text-white transition-colors" data-view="community-view">Community</a>
            <a href="#" class="info-link text-gray-400 hover:text-white transition-colors" data-view="about-view">About</a>
            <a href="#" class="info-link text-gray-400 hover:text-white transition-colors" data-view="privacy-terms-view">Privacy & Terms</a>
        </div>
        <p class="text-sm mt-2">Designed for students, researchers, and hobbyists. Content is for informational purposes only.</p>
    </footer>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, doc, getDoc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables provided by the canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const authToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db, auth;
        let heritageSites = [];
        let currentEditingSiteId = null;

        // --- AUTHENTICATION AND DATABASE INITIALIZATION ---
        async function initializeFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                if (authToken) {
                    await signInWithCustomToken(auth, authToken);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        console.log("User is signed in with ID:", user.uid);
                        listenForSites();
                    } else {
                        console.log("No user is signed in.");
                        showLoading(false);
                        renderCards([]);
                    }
                });

            } catch (e) {
                console.error("Error initializing Firebase:", e);
                const loading = document.getElementById('loading-message');
                loading.textContent = "Error loading data. Please try again later.";
            }
        }

        // --- FIRESTORE REAL-TIME LISTENER ---
        function listenForSites() {
            const collectionPath = `/artifacts/${appId}/public/data/heritageSites`;
            const sitesCollection = collection(db, collectionPath);
            
            showLoading(true);

            onSnapshot(sitesCollection, (snapshot) => {
                heritageSites = [];
                snapshot.forEach(doc => {
                    heritageSites.push({ id: doc.id, ...doc.data() });
                });
                console.log("Received new data from Firestore:", heritageSites.length, "sites.");
                showLoading(false);
                updateCards();
                updateTimeline();
            }, (error) => {
                console.error("Error fetching data from Firestore:", error);
                showLoading(false);
            });
        }

        // --- DOM ELEMENTS ---
        const mainView = document.getElementById('main-view');
        const timelineView = document.getElementById('timeline-view');
        const singleSiteView = document.getElementById('single-site-view');
        const addSiteView = document.getElementById('add-site-view');
        const communityView = document.getElementById('community-view');
        const aboutView = document.getElementById('about-view');
        const privacyTermsView = document.getElementById('privacy-terms-view');
        
        const contentGrid = document.getElementById('content-grid');
        const searchInput = document.getElementById('search-input');
        const searchClearBtn = document.getElementById('search-clear-btn');
        const noResultsMessage = document.getElementById('no-results-message');
        const loadingMessage = document.getElementById('loading-message');
        const filterButtons = document.querySelectorAll('.filter-btn');
        const headerFilterLinks = document.querySelectorAll('.header-filter-link');
        const portalHomeLink = document.getElementById('portal-home-link');
        const addSiteButton = document.getElementById('add-site-button');
        const viewTimelineButton = document.getElementById('view-timeline-button');
        const addSiteForm = document.getElementById('add-site-form');
        const cancelAddSiteButton = document.getElementById('cancel-add-site');
        const successModal = document.getElementById('success-modal');
        const successModalText = document.getElementById('success-modal-text');
        const successModalCloseBtn = document.getElementById('success-modal-close');
        const deleteModal = document.getElementById('delete-modal');
        const cancelDeleteBtn = document.getElementById('cancel-delete');
        const confirmDeleteBtn = document.getElementById('confirm-delete');
        const formTitle = document.getElementById('form-title');
        const submitSiteButton = document.getElementById('submit-site-button');
        const backButton = document.getElementById('back-button');
        const backButtonTimeline = document.getElementById('back-button-timeline');
        const infoLinks = document.querySelectorAll('.info-link');
        const contactForm = document.getElementById('contact-form');
        const contactSuccessModal = document.getElementById('contact-success-modal');
        const contactSuccessModalCloseBtn = document.getElementById('contact-success-modal-close');
        const timelineContent = document.getElementById('timeline-content');

        const singleSiteTitle = document.getElementById('single-site-title');
        const singleSiteImage = document.getElementById('single-site-image');
        const singleSiteDescription = document.getElementById('single-site-description');
        const singleSiteCategory = document.getElementById('single-site-category');
        const editSiteButton = document.getElementById('edit-site-button');
        const deleteSiteButton = document.getElementById('delete-site-button');

        let currentFilter = 'all';

        // An array of all main view elements to easily hide them
        const allViews = [mainView, singleSiteView, addSiteView, communityView, aboutView, privacyTermsView, timelineView];

        // --- FUNCTIONS ---
        function showLoading(show) {
            loadingMessage.classList.toggle('hidden', !show);
            contentGrid.classList.toggle('hidden', show);
        }

        // Function to control which view is visible
        function showView(viewToShow) {
            allViews.forEach(view => {
                view.classList.add('hidden');
            });
            viewToShow.classList.remove('hidden');
        }

        function showMainView() {
            showView(mainView);
            currentEditingSiteId = null;
        }

        async function showSingleSitePage(id) {
            const collectionPath = `/artifacts/${appId}/public/data/heritageSites`;
            const docRef = doc(db, collectionPath, id);
            currentEditingSiteId = id;

            try {
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    const site = docSnap.data();
                    singleSiteTitle.textContent = site.title;
                    singleSiteImage.src = site.image;
                    singleSiteImage.alt = site.title;
                    singleSiteImage.onerror = () => {
                        singleSiteImage.src = 'https://placehold.co/600x400/cccccc/333333?text=Image+Not+Found';
                    };
                    singleSiteDescription.textContent = site.detailedDescription;
                    singleSiteCategory.textContent = site.categories.map(c => c.charAt(0).toUpperCase() + c.slice(1)).join(' / ');
                    
                    showView(singleSiteView);
                } else {
                    console.log("No such document!");
                }
            } catch (e) {
                console.error("Error getting document:", e);
            }
        }

        function showAddSiteForm() {
            formTitle.textContent = "Add a New Heritage Site";
            submitSiteButton.textContent = "Add Site";
            submitSiteButton.classList.remove('bg-blue-500', 'hover:bg-blue-600');
            submitSiteButton.classList.add('bg-teal-500', 'hover:bg-teal-600');
            addSiteForm.reset();
            currentEditingSiteId = null;
            showView(addSiteView);
        }

        function showEditSiteForm() {
            const siteToEdit = heritageSites.find(s => s.id === currentEditingSiteId);
            if (!siteToEdit) {
                console.error("Site not found for editing.");
                return;
            }

            document.getElementById('site-title').value = siteToEdit.title;
            document.getElementById('site-year').value = siteToEdit.year;
            document.getElementById('site-description').value = siteToEdit.description;
            document.getElementById('site-detailed-description').value = siteToEdit.detailedDescription;
            document.getElementById('site-image').value = siteToEdit.image;
            
            const checkboxes = document.querySelectorAll('input[name="categories"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = siteToEdit.categories.includes(checkbox.value);
            });

            formTitle.textContent = "Edit Heritage Site";
            submitSiteButton.textContent = "Save Changes";
            submitSiteButton.classList.remove('bg-teal-500', 'hover:bg-teal-600');
            submitSiteButton.classList.add('bg-amber-500', 'hover:bg-amber-600');

            showView(addSiteView);
        }
        
        function renderCards(data) {
            contentGrid.innerHTML = '';
            if (data.length === 0) {
                noResultsMessage.classList.remove('hidden');
            } else {
                noResultsMessage.classList.add('hidden');
                data.forEach(item => {
                    const card = document.createElement('div');
                    card.className = `bg-white p-6 rounded-3xl shadow-lg border border-gray-200 heritage-card cursor-pointer hover:shadow-2xl hover:border-teal-400 transition-all duration-300 transform hover:-translate-y-2 card-animation`;
                    card.setAttribute('data-id', item.id);
                    card.innerHTML = `
                        <img src="${item.image}" onerror="this.onerror=null; this.src='https://placehold.co/600x400/cccccc/333333?text=Image+Not+Found';" alt="${item.title}" class="w-full h-48 object-cover rounded-2xl mb-4 shadow-md">
                        <h2 class="text-2xl font-bold text-slate-700 mb-2">${item.title}</h2>
                        <p class="text-gray-600 text-sm">${item.description}</p>
                        <a href="#" class="mt-4 inline-block text-teal-500 hover:underline">Read more &rarr;</a>
                    `;
                    contentGrid.appendChild(card);
                });
            }
        }

        function updateCards() {
            const searchTerm = searchInput.value.toLowerCase();
            const filteredSites = heritageSites.filter(site => {
                const categoryMatch = currentFilter === 'all' || (Array.isArray(site.categories) && site.categories.includes(currentFilter));
                const searchMatch = site.title.toLowerCase().includes(searchTerm) ||
                                    site.description.toLowerCase().includes(searchTerm) ||
                                    (Array.isArray(site.categories) && site.categories.join(' ').toLowerCase().includes(searchTerm));
                return categoryMatch && searchMatch;
            });
            renderCards(filteredSites);
        }

        function updateTimeline() {
            timelineContent.innerHTML = '';
            const sortedSites = [...heritageSites].sort((a, b) => a.year - b.year);
            let lastYear = null;
            sortedSites.forEach(site => {
                const timelineItem = document.createElement('div');
                timelineItem.className = 'timeline-item';
                
                let yearHeader = '';
                if (site.year !== lastYear) {
                    yearHeader = `<h3 class="text-2xl font-bold text-slate-800 mb-2 mt-4">${site.year}</h3>`;
                    lastYear = site.year;
                }

                timelineItem.innerHTML = `
                    ${yearHeader}
                    <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200 heritage-card cursor-pointer hover:shadow-2xl hover:border-teal-400 transition-all duration-300 transform hover:-translate-y-2">
                        <h4 class="text-xl font-bold text-slate-700 mb-1">${site.title}</h4>
                        <p class="text-gray-600 text-sm">${site.description}</p>
                        <a href="#" class="mt-2 inline-block text-teal-500 hover:underline" data-id="${site.id}">Read more &rarr;</a>
                    </div>
                `;
                timelineContent.appendChild(timelineItem);
            });
        }

        // --- EVENT LISTENERS ---

        initializeFirebase();

        searchInput.addEventListener('input', (event) => {
            const searchTerm = event.target.value.toLowerCase();
            searchClearBtn.style.display = searchTerm.length > 0 ? 'block' : 'none';
            updateCards();
        });

        searchClearBtn.addEventListener('click', () => {
            searchInput.value = '';
            searchClearBtn.style.display = 'none';
            updateCards();
        });

        filterButtons.forEach(button => {
            button.addEventListener('click', () => {
                filterButtons.forEach(btn => {
                    btn.classList.remove('active-filter', 'bg-teal-500', 'text-white');
                    btn.classList.add('bg-white', 'text-gray-700');
                });
                button.classList.add('active-filter', 'bg-teal-500', 'text-white');
                button.classList.remove('bg-white', 'text-gray-700');
                currentFilter = button.dataset.category;
                updateCards();
            });
        });

        headerFilterLinks.forEach(link => {
            link.addEventListener('click', (event) => {
                event.preventDefault();
                const category = event.target.dataset.category;
                
                // Show the main view and then filter
                showMainView();

                // Find and "click" the corresponding filter button
                const correspondingButton = document.querySelector(`.filter-btn[data-category="${category}"]`);
                if (correspondingButton) {
                    correspondingButton.click();
                }
            });
        });

        contentGrid.addEventListener('click', (event) => {
            const card = event.target.closest('.heritage-card');
            if (card) {
                const id = card.getAttribute('data-id');
                showSingleSitePage(id);
            }
        });
        
        timelineContent.addEventListener('click', (event) => {
            const link = event.target.closest('a');
            if (link && link.dataset.id) {
                event.preventDefault();
                showSingleSitePage(link.dataset.id);
            }
        });

        // Navigation links
        portalHomeLink.addEventListener('click', (event) => {
            event.preventDefault();
            // Reset filter and show all sites
            const allButton = document.querySelector('.filter-btn[data-category="all"]');
            if (allButton) {
                allButton.click();
            }
            showMainView();
        });
        backButton.addEventListener('click', showMainView);
        backButtonTimeline.addEventListener('click', showMainView);
        addSiteButton.addEventListener('click', showAddSiteForm);
        viewTimelineButton.addEventListener('click', () => {
            showView(timelineView);
            updateTimeline();
        });
        editSiteButton.addEventListener('click', showEditSiteForm);
        deleteSiteButton.addEventListener('click', () => {
            deleteModal.classList.remove('hidden');
        });
        
        infoLinks.forEach(link => {
            link.addEventListener('click', (event) => {
                event.preventDefault();
                const viewId = event.target.dataset.view;
                showView(document.getElementById(viewId));
            });
        });

        // Form Submission Handlers
        addSiteForm.addEventListener('submit', async (event) => {
            event.preventDefault();

            const formData = new FormData(addSiteForm);
            const siteData = {
                title: formData.get('title'),
                year: parseInt(formData.get('year')), // Ensure year is a number
                description: formData.get('description'),
                detailedDescription: formData.get('detailedDescription'),
                image: formData.get('image'),
                categories: formData.getAll('categories')
            };

            const collectionPath = `/artifacts/${appId}/public/data/heritageSites`;
            
            try {
                if (currentEditingSiteId) {
                    const siteRef = doc(db, collectionPath, currentEditingSiteId);
                    await updateDoc(siteRef, siteData);
                    successModalText.textContent = "Site Updated Successfully!";
                } else {
                    await addDoc(collection(db, collectionPath), siteData);
                    successModalText.textContent = "Site Added Successfully!";
                }

                showMainView();
                addSiteForm.reset();
                successModal.classList.remove('hidden');
            } catch (e) {
                console.error("Error saving document: ", e);
            }
        });
        
        // Contact form submission handler
        contactForm.addEventListener('submit', (event) => {
            event.preventDefault();
            // In a real application, you would send this data to a backend server.
            // For this example, we'll just show a success message.
            contactSuccessModal.classList.remove('hidden');
            contactForm.reset();
        });

        // Modal Close Handlers
        cancelAddSiteButton.addEventListener('click', () => {
            addSiteForm.reset();
            showMainView();
        });

        successModalCloseBtn.addEventListener('click', () => {
            successModal.classList.add('hidden');
        });
        
        contactSuccessModalCloseBtn.addEventListener('click', () => {
            contactSuccessModal.classList.add('hidden');
        });

        confirmDeleteBtn.addEventListener('click', async () => {
            deleteModal.classList.add('hidden');
            if (currentEditingSiteId) {
                const collectionPath = `/artifacts/${appId}/public/data/heritageSites`;
                const siteRef = doc(db, collectionPath, currentEditingSiteId);
                try {
                    await deleteDoc(siteRef);
                    successModalText.textContent = "Site Deleted Successfully!";
                    successModal.classList.remove('hidden');
                    showMainView();
                } catch (e) {
                    console.error("Error deleting document: ", e);
                }
            }
        });

        cancelDeleteBtn.addEventListener('click', () => {
            deleteModal.classList.add('hidden');
        });
    </script>
</body>
</html>
